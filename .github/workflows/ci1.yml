name: CI/CD - App Clima2

permissions:
  contents: read
  packages: write
  security-events: write

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
env:
  IMAGE_NAME: app_clima2
jobs:
  build-test-publish:
    runs-on: ubuntu-latest
    outputs:
      image-tag: ${{steps.set-tag.outputs.IMAGE_TAG}}

    steps:
      # Clonar el repositorio
      - name: Checkout codigo
        uses: actions/checkout@v4
      # Configurar Python
      - name: Configurar Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      # Instalar dependencias y testear
      - name: Instalar dependencias
        run: |
          python3 -m venv .venv
          source .venv/bin/activate
          python3 -m pip install --upgrade pip
          pip install --no-cache-dir -r requirements.txt
          pip install --no-cache-dir -r requirements-dev.txt

   #   - name: Ejecutar tests
   #     run: |
   #       if ./.venv/bin/python -m pytest -v; then
   #          echo "Tests OK"
   #       else
   #          echo "No hay tests - Se continua"
   #       fi
     #Ejecutar tests con coverage
      - name: Ejecutar tests con coverage
        run: |
         source .venv/bin/activate
         coverage run -m pytest
         coverage xml
      - name: Agrego TAG
        id: set-tag
        run: |
         TAG=${GITHUB_SHA::8}
         echo "IMAGE_TAG=$TAG" >> $GITHUB_ENV
         echo "::set-output name=IMAGE_TAG::$TAG"

       # Escaneo con sonar
      - name: SonarCloud Scan
        uses: SonarSource/sonarcloud-github-action@d08d592c0b694607865c089cba90bbf87c9a6d89  #v2
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}

      # Reporte para sonar
      - name: Descargar reporte SonarCloud (SARIF)
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        run: |
          curl -u "$SONAR_TOKEN:" \
          "https://sonarcloud.io/api/issues/search?componentKeys=JimenaPereyra_mundoseproyecto1&types=VULNERABILITY,BUG,CODE_SMELL&ps=500" \
          -o sonar_report.json

      - name: Subir artifact reporte SonarCloud
        uses: actions/upload-artifact@v4
        with:
          name: sonar_report
          path: sonar_report.json

      # Login a Docker Hub
      - name: Login a Docker Hub
        uses: docker/login-action@5e57cd118135c172c3672efd75eb46360885c0ef #v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      # Build y Push de imagen
      - name: Build y Push Docker image
        uses: docker/build-push-action@263435318d21b8e681c14492fe198d362a7d2c83 #v6
        with:
          context: .
          push: true
          tags: ${{ secrets.DOCKERHUB_USERNAME }}/${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}

      # Instalar Syft para SBOM
      - name: Instalar Syft
        run: |
          curl -sSfL https://raw.githubusercontent.com/anchore/syft/main/install.sh | sh -s -- -b/usr/local/bin

      # Generar SBOM desde la imagen Docker
      - name: Generar SBOM con Syft
        env:
         DOCKER_USER: ${{ secrets.DOCKERHUB_USERNAME }}
        run: |
          syft "$DOCKER_USER/${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}" -o cyclonedx-json > sbom_syft.json

      - name: Upload SBOM artifact
        uses: actions/upload-artifact@v4
        with:
          name: sbom_syft
          path: sbom_syft.json

      # Analisis de seguridad con Snyk
      - name: Snyk Security Scan
        uses: snyk/actions/python@9adf32b1121593767fc3c057af55b55db032dc04
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        run: |
          pip install snyk || true
          snyk auth $SNYK_TOKEN || true
          # scan dependencies
          if [ -f requirements.txt ]; then snyk test --file=requirements.txt || true; fi
          # scan the published image
          snyk container test ${{ secrets.DOCKERHUB_USERNAME }}/${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }} || true
