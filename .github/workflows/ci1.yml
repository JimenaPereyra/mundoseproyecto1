
name: CI/CD - App Clima2

permissions:
  contents: read
  packages: write
  security-events: write

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
env:
  IMAGE_NAME: app_clima2
jobs:
  build-test-publish:
    runs-on: ubuntu-latest
    outputs:
      image-tag: ${{steps.set-tag.outputs.IMAGE_TAG}}

    steps:
      # Clonar el repositorio
      - name: Checkout codigo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      # Configurar Python
      - name: Configurar Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      # Instalar dependencias y testear
      - name: Instalar dependencias
        run: |
          python3 -m venv .venv
          source .venv/bin/activate
          python3 -m pip install --upgrade pip
          pip install --no-cache-dir -r requirements.txt
          pip install --no-cache-dir -r requirements-dev.txt

     #Ejecutar tests con coverage
      - name: Ejecutar tests con coverage
        run: |
         source .venv/bin/activate
         python -m pytest --cov=app_clima2 --cov-report=term --cov-report=xml:coverage.xml

         # Verificación rápida (opcional)
         head -n 40 coverage.xml || true

      - name: Agrego TAG
        id: set-tag
        run: |
         TAG=${GITHUB_SHA::8}
         echo "IMAGE_TAG=$TAG" >> $GITHUB_ENV
         echo "::set-output name=IMAGE_TAG::$TAG"

       # Escaneo con sonar
      - name: SonarCloud Scan
        uses: SonarSource/sonarcloud-github-action@d08d592c0b694607865c089cba90bbf87c9a6d89  #v2
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}

      # Reporte para sonar
      - name: Descargar reporte SonarCloud (SARIF)
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        run: |
          curl -u "$SONAR_TOKEN:" \
          "https://sonarcloud.io/api/issues/search?componentKeys=JimenaPereyra_mundoseproyecto1&types=VULNERABILITY,BUG,CODE_SMELL&ps=500" \
          -o sonar_report.json

      - name: Subir artifact reporte SonarCloud
        uses: actions/upload-artifact@v4
        with:
          name: sonar_report
          path: sonar_report.json

      # Login a Docker Hub
      - name: Login a Docker Hub
        uses: docker/login-action@5e57cd118135c172c3672efd75eb46360885c0ef #v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      # Build y Push de imagen
      - name: Build y Push Docker image
        uses: docker/build-push-action@263435318d21b8e681c14492fe198d362a7d2c83 #v6
        with:
          context: .
          push: true
          tags: ${{ secrets.DOCKERHUB_USERNAME }}/${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}
      - name: Export Docker image
        env:
         DOCKER_USER: ${{ secrets.DOCKERHUB_USERNAME }}
        run: |
          docker save \
            ${DOCKER_USER}/${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }} \
            -o app_clima2_${{ env.IMAGE_TAG }}.tar

      - name: Upload Docker image artifact
        uses: actions/upload-artifact@v4
        with:
           name: docker-image
           path: app_clima2_${{ env.IMAGE_TAG }}.tar

      # Instalar Syft para SBOM
      - name: Instalar Syft
        run: |
          set -e

          sudo apt-get update -y
          sudo apt-get install -y jq

          # Obtener release usando HTTPS estricto
          RELEASE=$(curl --fail --silent --show-error --location --proto '=https' --tlsv1.2 \
            https://api.github.com/repos/anchore/syft/releases/latest)

          SYFT_VERSION=$(echo "$RELEASE" | jq -r .tag_name)

          ASSET_URL=$(echo "$RELEASE" | jq -r \
            '.assets[] | select(.name | test("linux_amd64.*\\.tar\\.gz$")) | .browser_download_url')

          CHECKSUMS_URL=$(echo "$RELEASE" | jq -r \
            '.assets[] | select(.name | test("checksums.txt$")) | .browser_download_url')

          echo "Descargando asset seguro: $ASSET_URL"
          FILE_NAME=$(basename "$ASSET_URL")

          curl --fail --silent --show-error --location --proto '=https' --tlsv1.2 \
            -o "$FILE_NAME" "$ASSET_URL"

          curl --fail --silent --show-error --location --proto '=https' --tlsv1.2 \
            -o checksums.txt "$CHECKSUMS_URL"

          grep "$FILE_NAME" checksums.txt | sha256sum --check -

          sudo tar -xzf "$FILE_NAME" -C /usr/local/bin syft || \
            sudo tar -xzf "$FILE_NAME" -C /usr/local/bin --wildcards 'syft*'

          echo "Syft instalado correctamente."

      # Generar SBOM desde la imagen Docker
      - name: Generar SBOM con Syft
        env:
         DOCKER_USER: ${{ secrets.DOCKERHUB_USERNAME }}
        run: |
          syft "$DOCKER_USER/${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}" -o cyclonedx-json > sbom_syft.json

      - name: Upload SBOM artifact
        uses: actions/upload-artifact@v4
        with:
          name: sbom_syft
          path: sbom_syft.json

      # Analisis de seguridad con Snyk
      - name: Snyk Security Scan
        uses: snyk/actions/docker@ff5c02a0e3adc5c52e2c9e7558edf2b46d69ac1f #master
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          image: ${{ secrets.DOCKERHUB_USERNAME }}/${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}
          command: test
          args: --severity-threshold=high
          sarif: false

  deploy:
    name: Terraform deploy to AWS (EC2)
    runs-on: ubuntu-latest
    needs: build-test-publish
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@a1502cd9e758c50496cc9ac5308c4843bcd56d36 #v3
        with:
          terraform_version: 1.8.5

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@5fd3084fc36e372ff1fff382a39b10d03659f355 #v2
        with:
          aws-region: ${{ secrets.AWS_REGION }}
          # or use access keys:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}

      - name: Debug AWS identity
        run: aws sts get-caller-identity

      - name: Terraform Init
        working-directory: ./terraform
        run: terraform init

      - name: Terraform Plan
        working-directory: ./terraform
        env:
          SSH_PUBLIC_KEY: ${{ secrets.SSH_PUBLIC_KEY }}
          WEATHER_API_KEY: ${{ secrets.WEATHER_API_KEY }}
        run: |
          terraform plan -refresh=false -out=tfplan \
            -var "ssh_public_key=$SSH_PUBLIC_KEY" \
            -var "weather_api_key=$WEATHER_API_KEY"

      - name: Terraform Apply
        if: github.ref == 'refs/heads/main'
        working-directory: ./terraform
        run: |
          terraform apply -auto-approve tfplan

      - name: Get EC2 IP from Terraform
        id: ec2_ip
        run: echo "EC2_IP=$(terraform output -raw public_ip)" >> $GITHUB_ENV
        working-directory: ./terraform
      - name: Output instance info
        if: github.ref == 'refs/heads/main'
        working-directory: ./terraform
        run: terraform output -json > tf_outputs.json

      - name: Upload terraform outputs
        if: github.ref == 'refs/heads/main'
        uses: actions/upload-artifact@v4
        with:
          name: terraform-outputs
          path: tf_outputs.json

      - name: Obtener SG creado por Terraform
        id: sg
        working-directory: ./terraform
        run: |
          SG_ID=$(terraform output -raw ec2_security_group_id)
          echo "SG_ID=$SG_ID" >> $GITHUB_ENV
          echo "Security Group obtenido: $SG_ID"

      - name: Add temporary GitHub Runner IP to security group
        run: |

          RUNNER_IP=$(curl -s https://api.ipify.org)

          echo "Runner IP: $RUNNER_IP"
          echo "Security Group: $SG_ID"

          aws ec2 authorize-security-group-ingress \
            --group-id "$SG_ID" \
            --protocol tcp \
            --port 22 \
            --cidr "$RUNNER_IP/32"

          echo "Temporary IP added."

        env:
          AWS_REGION: us-east-1


      - name: Wait for EC2 SSH to be ready
        run: |
          echo "Waiting for EC2 to accept SSH..."
          for i in {1..15}; do
            if nc -zv $EC2_IP 22; then
              echo "SSH is ready!"
              exit 0
            fi
            echo "Retrying in 10 seconds..."
            sleep 10
          done
          echo "EC2 not ready after waiting."
          exit 1

      - name: Deploy app en EC2 vía SSH
        env:
          EC2_SSH_PRIVATE_KEY: ${{ secrets.EC2_SSH_PRIVATE_KEY }}
          WEATHER_API_KEY: ${{ secrets.WEATHER_API_KEY }}
          SECRET_KEY: ${{ secrets.SECRET_KEY }}
        run: |
          echo "$EC2_SSH_PRIVATE_KEY" > ssh_key.pem
          chmod 600 ssh_key.pem


          ssh -o StrictHostKeyChecking=no -i ssh_key.pem ubuntu@$EC2_IP << EOF
          set -e

          echo "[1/5] Instalando dependencias base..."
          sudo apt-get update -y
          sudo apt-get install -y ca-certificates curl git

          echo "[2/5] Instalando Docker Engine..."
          sudo install -m 0755 -d /etc/apt/keyrings
          sudo curl -fsSL https://download.docker.com/linux/ubuntu/gpg -o /etc/apt/keyrings/docker.asc
          sudo chmod a+r /etc/apt/keyrings/docker.asc

          cat <<EOT | sudo tee /etc/apt/sources.list.d/docker.sources
          Types: deb
          URIs: https://download.docker.com/linux/ubuntu
          Suites: jammy
          Components: stable
          Signed-By: /etc/apt/keyrings/docker.asc
          EOT

          sudo apt-get update -y
          sudo apt-get install -y \
           docker-ce docker-ce-cli containerd.io \
           docker-buildx-plugin docker-compose-plugin

          echo "[3/5] Habilitando Docker..."
          sudo systemctl enable --now docker

          echo "[4/5] Descargando proyecto..."
          cd /home/ubuntu
          if [ ! -d "proyecto" ]; then
             git clone https://github.com/JimenaPereyra/mundoseproyecto1.git proyecto
          fi
          cd proyecto
          git pull

          cat <<ENVFILE > .env
          WEATHER_API_KEY=${WEATHER_API_KEY}
          SECRET_KEY=${SECRET_KEY}
          CACHE_TTL_SECONDS=60
          ENVFILE

          echo "Contenido de .env creado en EC2:"
          cat .env

          echo "[5/5] Levantando contenedores..."

          sudo docker compose down || true
          sudo docker compose up -d --build

          echo "Deploy completado correctamente en la EC2."
          EOF

#      - name: Wait for Docker inside EC2
#        uses: appleboy/ssh-action@v1.0.3
#        with:
#          host: ${{ env.EC2_IP }}
#          username: ubuntu
#          key: ${{ secrets.EC2_SSH_PRIVATE_KEY }}
#          script: |
#            echo "Waiting for Docker to be ready..."
#            for i in {1..15}; do
#              if command -v docker >/dev/null 2>&1; then
#                echo "Docker installed!"
#                # Check if Docker daemon is running
#                if sudo docker info >/dev/null 2>&1; then
#                  echo "Docker daemon is ready!"
#                  exit 0
#                fi
#              fi
#              echo "Docker not ready yet, retrying..."
#              sleep 10
#            done
#            echo "Docker did not become ready in time"
#            exit 1
#      - name: Install Git on EC2
#        run: |
#          echo "${{ secrets.EC2_SSH_PRIVATE_KEY }}" > ssh_key.pem
#          chmod 600 ssh_key.pem

#          ssh -o StrictHostKeyChecking=no -i ssh_key.pem ubuntu@$EC2_IP << 'EOF'
#          sudo apt-get update -y
#          sudo apt-get install -y git
#          echo "Waiting for Docker inside EC2..."
#          for i in {1..15}; do
#           if command -v docker >/dev/null 2>&1; then
#             echo "Docker installed."
#             if sudo docker info >/dev/null 2>&1; then
#               echo "Docker daemon is ready!"
#               break
#             fi
#           fi
#           echo "Docker not ready yet... retrying"
#           sleep 15
#          done
#          # Clonar repositorio
#          if [ ! -d "proyecto" ]; then
#            git clone https://github.com/JimenaPereyra/mundoseproyecto1.git proyecto
#          fi
#          cd proyecto

#          echo "Waiting for docker compose to be ready..."
#          for i in {1..15}; do
#            if docker compose version >/dev/null 2>&1; then
#              echo "docker compose is ready!"
#              break
#            fi
#            echo "docker compose not ready yet… retrying"
#            sleep 10
#          done

#          # Última verificación
#          sudo docker-compose version || { echo "docker compose FAILED"; exit 1; }

#          # Exportar variables (poner aquí tus secrets)
#          export WEATHER_API_KEY="${WEATHER_API_KEY}"
#          export SECRET_KEY="${SECRET_KEY}"

#          sudo docker-compose down
#          sudo docker-compose up -d --build
#          EOF
#        env:
#         WEATHER_API_KEY: ${{ secrets.WEATHER_API_KEY }}
#         SECRET_KEY: ${{ secrets.SECRET_KEY }}
#
#      - name: Start Grafana on EC2
#        uses: appleboy/ssh-action@v1.0.3
#        with:
#          host: ${{ env.EC2_IP }}
#          username: ubuntu
#          key: ${{ secrets.EC2_SSH_PRIVATE_KEY }}
#          script: |
#            sudo docker stop grafana || true
#            sudo docker rm grafana || true
#            sudo docker run -d -p 3000:3000 --name grafana grafana/grafana:latest
#
#      - name: Deploy Prometheus via Docker Compose
#        uses: appleboy/ssh-action@v1.0.3
#        with:
#          host: ${{ env.EC2_IP }}
#          username: ubuntu
#          key: ${{ secrets.EC2_SSH_PRIVATE_KEY }}
#          script: |
#             # Instalar Docker Compose manualmente
#             sudo curl -L "https://github.com/docker/compose/releases/download/v2.24.6/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
#             sudo chmod +x /usr/local/bin/docker-compose
#
#              echo ">>> Crear prometheus.yml"
#              cat << 'EOF' > /home/ubuntu/prometheus.yml
#              global:
#                scrape_interval: 15s
#              scrape_configs:
#                - job_name: 'app_clima'
#                  static_configs:
#                    - targets: ['localhost:8000']
#             EOF
#              echo ">>> Crear docker-compose-prometheus.yml"
#              cat << 'EOF' > /home/ubuntu/docker-compose-prometheus.yml
#              version: "3.9"
#              
#              services:
#                prometheus:
#                  image: prom/prometheus:latest
#                  container_name: prometheus
#                  ports:
#                    - "9090:9090"
#                  volumes:
#                    - ./prometheus.yml:/etc/prometheus/prometheus.yml
#                  restart: always
#             EOF
#              sudo docker-compose -f /home/ubuntu/docker-compose-prometheus.yml down || true
#              sudo docker-compose -f /home/ubuntu/docker-compose-prometheus.yml up -d
